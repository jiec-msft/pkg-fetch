name: Explore Native Windows ARM64 Build

# This workflow explores building Node.js natively on Windows ARM64 runners
# instead of cross-compiling from x64. Native builds may have better compatibility
# and don't require cross-compilation workarounds.

on:
  workflow_dispatch:
    inputs:
      target-node:
        description: 'Node.js major version to build'
        default: '22'
        type: choice
        options:
          - '20'
          - '22'
          - '24'

permissions:
  contents: read

jobs:
  native-arm64-build:
    name: Native Windows ARM64 Build
    runs-on: windows-11-arm

    steps:
      - uses: actions/checkout@v4

      - name: System Information
        run: |
          Write-Host "=== System Information ==="
          Write-Host "OS: $([System.Environment]::OSVersion.VersionString)"
          Write-Host "Architecture: $env:PROCESSOR_ARCHITECTURE"
          Write-Host "Number of Processors: $env:NUMBER_OF_PROCESSORS"
          
          # Check if running on native ARM64
          if ($env:PROCESSOR_ARCHITECTURE -eq "ARM64") {
            Write-Host "✅ Running on native ARM64 hardware"
          } else {
            Write-Host "⚠️ Not running on native ARM64 hardware"
          }

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Check Node.js Architecture
        run: |
          Write-Host "Node.js version: $(node --version)"
          Write-Host "Node.js architecture: $(node -p 'process.arch')"
          Write-Host "Node.js platform: $(node -p 'process.platform')"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          check-latest: true

      - name: Check Python Architecture
        run: |
          python --version
          python -c "import platform; print(f'Python architecture: {platform.machine()}')"

      - run: yarn install --ignore-engines

      - name: Install NASM
        run: choco install nasm
        continue-on-error: true

      - name: Check Visual Studio Build Tools
        run: |
          # Check for Visual Studio installations
          $vsWhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
          if (Test-Path $vsWhere) {
            Write-Host "=== Visual Studio Installations ==="
            & $vsWhere -all -format json | ConvertFrom-Json | ForEach-Object {
              Write-Host "  - $($_.displayName) at $($_.installationPath)"
            }
          }
          
          # Check for ARM64 build tools
          Write-Host "`n=== Checking ARM64 Build Tools ==="
          $arm64Paths = @(
            "${env:ProgramFiles}\Microsoft Visual Studio\2022\Enterprise\VC\Tools\MSVC\*\bin\Hostarm64\arm64",
            "${env:ProgramFiles}\Microsoft Visual Studio\2022\Professional\VC\Tools\MSVC\*\bin\Hostarm64\arm64",
            "${env:ProgramFiles}\Microsoft Visual Studio\2022\Community\VC\Tools\MSVC\*\bin\Hostarm64\arm64"
          )
          
          foreach ($pathPattern in $arm64Paths) {
            $matches = Get-ChildItem -Path $pathPattern -ErrorAction SilentlyContinue
            if ($matches) {
              Write-Host "Found ARM64 tools at: $($matches.FullName)"
            }
          }

      - name: Build Node.js binary (native ARM64)
        id: build
        run: |
          Write-Host "=== Starting Native ARM64 Build ==="
          Write-Host "Building Node.js ${{ github.event.inputs.target-node || '22' }} for ARM64"
          
          # Set environment to prefer native ARM64 toolchain
          $env:PreferredToolArchitecture = "arm64"
          
          yarn start --node-range node${{ github.event.inputs.target-node || '22' }} --arch arm64 --output dist
        continue-on-error: true

      - name: Check Build Output
        run: |
          Write-Host "=== Build Output ==="
          if (Test-Path dist) {
            Get-ChildItem -Path dist -Recurse | ForEach-Object {
              Write-Host "  $($_.FullName) - $($_.Length) bytes"
            }
          } else {
            Write-Host "No dist directory found"
          }

      - name: Verify Binary Architecture
        if: success() || failure()
        run: |
          $exeFile = Get-ChildItem -Path dist -Filter "*.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($exeFile) {
            Write-Host "Found executable: $($exeFile.FullName)"
            
            # Check PE header for architecture
            $bytes = [System.IO.File]::ReadAllBytes($exeFile.FullName)
            $peOffset = [BitConverter]::ToInt32($bytes, 0x3C)
            $machine = [BitConverter]::ToUInt16($bytes, $peOffset + 4)
            
            switch ($machine) {
              0x014c { Write-Host "Architecture: x86 (i386)" }
              0x8664 { Write-Host "Architecture: x64 (AMD64)" }
              0xAA64 { Write-Host "Architecture: ARM64" }
              default { Write-Host "Architecture: Unknown ($machine)" }
            }
          } else {
            Write-Host "No executable found in dist"
          }

      - name: Test ICU Support
        if: success() || failure()
        run: |
          $exeFile = Get-ChildItem -Path dist -Filter "*.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($exeFile) {
            Write-Host "Testing ICU support in: $($exeFile.FullName)"
            & $exeFile.FullName scripts/test-icu.js
            if ($LASTEXITCODE -eq 0) {
              Write-Host "`n✅ All tests passed!"
            } else {
              Write-Host "`n❌ Tests failed!"
            }
          } else {
            Write-Host "No executable found to test"
          }

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: native-arm64-build-node${{ github.event.inputs.target-node || '22' }}
          path: dist\*
          if-no-files-found: ignore

  compare-with-cross-compile:
    name: Compare with Cross-Compiled Build
    runs-on: windows-2022
    
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          check-latest: true

      - run: yarn install --ignore-engines

      - run: choco install nasm

      - name: Build Node.js binary (cross-compiled ARM64)
        run: |
          Write-Host "=== Cross-Compiling ARM64 from x64 ==="
          yarn start --node-range node${{ github.event.inputs.target-node || '22' }} --arch arm64 --output dist

      - name: Check Build Output
        run: |
          Write-Host "=== Cross-Compiled Build Output ==="
          if (Test-Path dist) {
            Get-ChildItem -Path dist -Recurse | ForEach-Object {
              Write-Host "  $($_.FullName) - $($_.Length) bytes"
            }
          }

      - uses: actions/upload-artifact@v4
        with:
          name: cross-compiled-arm64-build-node${{ github.event.inputs.target-node || '22' }}
          path: dist\*
          if-no-files-found: ignore
